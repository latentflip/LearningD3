<!DOCTYPE html>  <html> <head>   <title>collider.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               collider.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Collider is a simple game</p>

<ul>
<li>we have a player, and some enemies, who move randomly</li>
<li>if the player gets hit, our score is reset</li>
<li>otherwise our score goes up over time</li>
<li><a href="http://latentflip.github.com/LearningD3/collider">Play it here</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Setup the environment</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Some basic parameters for our game</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">gameOptions =</span>
  <span class="nv">height: </span><span class="mi">450</span>
  <span class="nv">width: </span><span class="mi">700</span>
  <span class="nv">nEnemies: </span><span class="mi">30</span>
  <span class="nv">padding: </span><span class="mi">20</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Somewhere to dump the score</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">gameStats =</span>
  <span class="nv">score: </span><span class="mi">0</span>
  <span class="nv">bestScore: </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Setup the game board</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Axes</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Our game coordinates range from 0 to 100 in both x and y
axes. This gets mapped to our pixelled game area using these
scale functions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">axes =</span>
  <span class="nv">x: </span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nx">gameOptions</span><span class="p">.</span><span class="nx">width</span><span class="p">])</span>
  <span class="nv">y: </span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nx">gameOptions</span><span class="p">.</span><span class="nx">height</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Game Board (svg region)</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This looks like jQuery, and it is.</p>

<ul>
<li>find the container element in the DOM</li>
<li>append an svg element to it</li>
<li>and set some attributes on the element</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">gameBoard = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;.container&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:svg&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">gameOptions</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nx">gameOptions</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Scores</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Update our scoreboard, which is just in an html span</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">updateScore = </span><span class="o">-&gt;</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#current-score&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">gameStats</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Update our best score if current score is bigger, 
and update the scoreboard</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">updateBestScore = </span><span class="o">-&gt;</span>
  <span class="nv">gameStats.bestScore =</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">max</span> <span class="p">[</span><span class="nx">gameStats</span><span class="p">.</span><span class="nx">bestScore</span><span class="p">,</span> <span class="nx">gameStats</span><span class="p">.</span><span class="nx">score</span><span class="p">]</span>

  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#best-score&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">gameStats</span><span class="p">.</span><span class="nx">bestScore</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>The Player</h2>

<p>The player is a circle that the user can drag around the board with their mouse</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Let's stick everything in a class to keep it clean</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Player</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>An svg path, created using <a href="http://svg-edit.googlecode.com/svn/branches/2.5.1/editor/svg-editor.html">this tool</a> to give our player a teardrop shape</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">path: </span><span class="s1">&#39;m-7.5,1.62413c0,-5.04095 4.08318,-9.12413 9.12414,-9.12413c5.04096,0 9.70345,5.53145 11.87586,9.12413c-2.02759,2.72372 -6.8349,9.12415 -11.87586,9.12415c-5.04096,0 -9.12414,-4.08318 -9.12414,-9.12415z&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Some state for the player to maintain</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fill: </span><span class="s1">&#39;#ff6600&#39;</span>
  <span class="nv">x: </span><span class="mi">0</span>
  <span class="nv">y: </span><span class="mi">0</span>
  <span class="nv">angle: </span><span class="mi">0</span>
  <span class="nv">r: </span><span class="mi">5</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>We need the gameOptions hash to restrict his motion</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(gameOptions) -&gt;</span>
    <span class="vi">@gameOptions = </span><span class="nx">gameOptions</span>
  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Render the path to the gameBoard, and moves it to the middle
also initializes dragging on the svg element</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="vi">@el = </span><span class="nx">to</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:path&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">@path</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="nx">@fill</span><span class="p">)</span>
    <span class="nx">@transform</span>
      <span class="nv">x: </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="mf">0.5</span>
      <span class="nv">y: </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="nx">@setupDragging</span><span class="p">()</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Getters and setters to ensure the player stays within the game
boundary</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getX: </span><span class="o">=&gt;</span> <span class="nx">@x</span>
  <span class="nv">setX: </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">minX = </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">padding</span>
    <span class="nv">maxX = </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">padding</span>
    <span class="nv">x = </span><span class="nx">minX</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">minX</span>
    <span class="nv">x = </span><span class="nx">maxX</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">maxX</span>
    <span class="vi">@x = </span><span class="nx">x</span>

  <span class="nv">getY: </span><span class="o">=&gt;</span> <span class="nx">@y</span>
  <span class="nv">setY: </span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">minY = </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">padding</span>
    <span class="nv">maxY = </span><span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">@gameOptions</span><span class="p">.</span><span class="nx">padding</span>
    <span class="nv">y = </span><span class="nx">minY</span> <span class="k">if</span> <span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">minY</span>
    <span class="nv">y = </span><span class="nx">maxY</span> <span class="k">if</span> <span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">maxY</span>
    <span class="vi">@y = </span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Since the player is an svg:path, we have to move/rotate him
using transform. This method just lets us set any/all of the
attributes and the rest will be taken from his internal state</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">transform: </span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="vi">@angle = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">angle</span> <span class="o">||</span> <span class="nx">@angle</span>
    <span class="nx">@setX</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="nx">@x</span>
    <span class="nx">@setY</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">y</span> <span class="o">||</span> <span class="nx">@y</span>

    <span class="nx">@el</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;transform&#39;</span><span class="p">,</span>
      <span class="s2">&quot;rotate(#{@angle},#{@getX()},#{@getY()}) &quot;</span><span class="o">+</span>
      <span class="s2">&quot;translate(#{@getX()},#{@getY()})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Moves the player to an absolute position on the gameboard</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveAbsolute: </span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@transform</span>
      <span class="nx">x</span><span class="o">:</span><span class="nx">x</span>
      <span class="nx">y</span><span class="o">:</span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Moves the player to a relative position, rotating him based
on which direction he is moving</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveRelative: </span><span class="p">(</span><span class="nx">dx</span><span class="p">,</span><span class="nx">dy</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@transform</span>
      <span class="nv">x: </span><span class="nx">@getX</span><span class="p">()</span><span class="o">+</span><span class="nx">dx</span>
      <span class="nv">y: </span><span class="nx">@getY</span><span class="p">()</span><span class="o">+</span><span class="nx">dy</span>
      <span class="nv">angle: </span><span class="mi">360</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">dy</span><span class="p">,</span><span class="nx">dx</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Use d3's behaviors to make the player draggable</p>

<ul>
<li>When he is dragged, move him the amount that the mouse
moved (available in the global current user event: d3.event)</li>
<li>Setup dragging using d3's drag behaviour and bind <code>dragMove</code>
to the on 'drag' event</li>
<li>Apply the drag behaviour to the player's svg element</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setupDragging: </span><span class="o">=&gt;</span>
    <span class="nv">dragMove = </span><span class="o">=&gt;</span>
      <span class="nx">@moveRelative</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">dx</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">dy</span><span class="p">)</span>

    <span class="nv">drag = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">behavior</span><span class="p">.</span><span class="nx">drag</span><span class="p">()</span>
            <span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s1">&#39;drag&#39;</span><span class="p">,</span> <span class="nx">dragMove</span><span class="p">)</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">drag</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create our player by rendering him to the gameBoard</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">players = </span><span class="p">[]</span>
<span class="nx">players</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">(</span><span class="nx">gameOptions</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span><span class="nx">gameBoard</span><span class="p">)</span>
<span class="nx">players</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">(</span><span class="nx">gameOptions</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span><span class="nx">gameBoard</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h2>Enemies</h2>

<p>The enemies are an array of simple objects with positions and an id,
they get rendered and updated in the <code>render</code> method</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Creates an array of enemy data with random x and y positions
by also creating an id, d3 can keep track of the enemies
and move them rather than creating new ones later</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">createEnemies = </span><span class="o">-&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">gameOptions</span><span class="p">.</span><span class="nx">nEnemies</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(i) -&gt;</span>
    <span class="p">{</span>
      <span class="nv">id: </span><span class="nx">i</span>
      <span class="nv">x: </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
      <span class="nv">y: </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>Rendering the gameboard</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">render = </span><span class="nf">(enemy_data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Select all the enemies on the board
and bind the data to them, using the enemies'
id attribute as a key to ensure we update enemies
in the future</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">enemies = </span><span class="nx">gameBoard</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;circle.enemy&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">enemy_data</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>enter()</h3>

<p>any enemies which have just entered the game,
i.e. who haven't already got a circle bound to
an <code>id</code> will be in the <code>enter()</code> subset, so...</p>

<ul>
<li>add a class to identify the enemy</li>
<li>position the enemy on tbe board using the axis transforms</li>
<li>start the enemy with no radius (we will increase it threateningly later)</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">enemies</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg:circle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;enemy&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="nf">(enemy) -&gt;</span> <span class="nx">axes</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">enemy</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span> <span class="nf">(enemy) -&gt;</span> <span class="nx">axes</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">enemy</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h3>exit()</h3>

<p>if we have removed any enemies (currently this won't happen)
i.e. a circle is bound to an <code>id</code> that is no longer in the 
<code>enemy_data</code> array, just remove the enemy from the board</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">enemies</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">remove</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>update()</h3>

<p>If an enemies <code>id</code> is already on the board, and is still in
the <code>enemy_data</code> array, we just want to update the enemies position.</p>

<p>We will do this using a custom tween so we can test whether any
enemies collide with our player on each step of the animation</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h4>Collision Detection</h4>

<p>very simple collision detection
find the distance between the centers of an enemy and the players
and if it's less the sum of their radii, there's been a collision
so invoke the callback</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">checkCollision = </span><span class="nf">(enemy, collidedCallback) -&gt;</span>
    <span class="nx">_</span><span class="p">(</span><span class="nx">players</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(player) -&gt;</span>
      <span class="nv">radiusSum = </span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nx">player</span><span class="p">.</span><span class="nx">r</span>
      <span class="nv">xDiff = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nx">player</span><span class="p">.</span><span class="nx">x</span>
      <span class="nv">yDiff = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nx">player</span><span class="p">.</span><span class="nx">y</span>

      <span class="nv">separation = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">xDiff</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">yDiff</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
      <span class="nx">collidedCallback</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">enemy</span><span class="p">)</span> <span class="k">if</span> <span class="nx">separation</span> <span class="o">&lt;</span> <span class="nx">radiusSum</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>If we have a collision, just reset the score</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onCollision = </span><span class="o">-&gt;</span>
    <span class="nx">updateBestScore</span><span class="p">()</span>
    <span class="nv">gameStats.score = </span><span class="mi">0</span>
    <span class="nx">updateScore</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h4>Custom Tween</h4>

<p>Create a custom tween, that tests if the enemy has
collided with the player on each tick
The tween gets called once at the start of the tween
with the data we are tweening to.
The tween should yield a function that takes a "timestep" <code>t</code>
which is between 0 and 1 (0 at the start of the tween, 1 at
the end).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tweenWithCollisionDetection = </span><span class="nf">(endData) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><code>this</code> is our svg element, so wrap with d3</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">enemy = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Get the initial position of the enemy </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">startPos =</span>
      <span class="nv">x: </span><span class="nb">parseFloat</span> <span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">)</span>
      <span class="nv">y: </span><span class="nb">parseFloat</span> <span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Map our endData to endPosition using our axes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">endPos =</span>
      <span class="nv">x: </span><span class="nx">axes</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">endData</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
      <span class="nv">y: </span><span class="nx">axes</span><span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="nx">endData</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Return our custom tween function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nf">(t) -&gt;</span>
      <span class="nx">checkCollision</span><span class="p">(</span><span class="nx">enemy</span><span class="p">,</span> <span class="nx">onCollision</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Next position, is 
`start_position + (end_position - start_position)*timestep</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">enemyNextPos =</span>
        <span class="nv">x: </span><span class="nx">startPos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">endPos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">startPos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span><span class="o">*</span><span class="nx">t</span>
        <span class="nv">y: </span><span class="nx">startPos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">endPos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">startPos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="o">*</span><span class="nx">t</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Update the enemy's position</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">enemy</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="nx">enemyNextPos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span> <span class="nx">enemyNextPos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Bind two transitions to the enemies when they are created/updated</p>

<ul>
<li>The first will grow the enemies radius using a built in tween (the
animation will only show on the first round)</li>
<li>The second uses our custom tween and will run every round to move
the enemies on the board</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">enemies</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="nx">tweenWithCollisionDetection</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h2>Play the game!</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Kick off the game, and set the turn iterations off</p>

<ul>
<li>On every turn, update enemy positions, and re-render</li>
<li>On every score tick, update the score, and the scoreboard</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">play = </span><span class="o">-&gt;</span>
  <span class="nv">gameTurn = </span><span class="o">-&gt;</span>
    <span class="nv">newEnemyPositions = </span><span class="nx">createEnemies</span><span class="p">()</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">newEnemyPositions</span><span class="p">)</span>

  <span class="nv">increaseScore = </span><span class="o">-&gt;</span>
    <span class="nx">gameStats</span><span class="p">.</span><span class="nx">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">updateScore</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Take a turn every 2 seconds</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">gameTurn</span><span class="p">()</span>
  <span class="nx">setInterval</span> <span class="nx">gameTurn</span><span class="p">,</span> <span class="mi">2000</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Increment the score counter every 50ms</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setInterval</span> <span class="nx">increaseScore</span><span class="p">,</span> <span class="mi">50</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Play!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">play</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 